---
title: "GLM"
author: "Thanh Chuong Cao"
date: "5/4/2023"
output: html_document
---

```{r}
#Import data
setwd("/Users/dr.thanhchuong/Documents/GLM")
EG_data <- read.table("EG.dat", sep = ' ',header = T)
#Count the number of normal, malformed and dead for each litter
library(magrittr)
library(dplyr)
normal <- EG_data %>% count(id, response) %>% filter(response == 1) # count normal in each clusters
malformed <- EG_data %>% count(id, response) %>% filter(response == 2) # count malformed in each clusters
dead <-  EG_data %>% count(id, response) %>% filter(response == 3) # count dead in each clusters
dose <- EG_data %>% count(id, dose)
normal
dose
```

```{r}
#Merge the data, remove columns, rename and substitute the NA values with 0 values
data1 <- merge(dose, normal[, -c(2)], by = 'id', all.x = T)
data1 <- merge(data1, malformed[, -c(2)], by = 'id', all.x = T)
data1<- merge(data1, dead[, -c(2)], by = 'id', all.x = T)
colnames(data1) <- c('id', 'dose', 'size','normal', 'malformed', 'dead')
data1[is.na(data1)] <- 0
EG <- data1
EG
```

# 1. Binary malformation indicator for a normal response against a malformed or dead response
```{r}
# Transform in to binary outcome indicating normal
EG_data$dose <- as.numeric(EG_data$dose)
EG_data$outcome <- EG_data$response
EG_data$outcome[EG_data$response == 2] <- 0
EG_data$outcome[EG_data$response == 3] <- 0
EG_data$outcome <- as.factor(EG_data$outcome) 
```

```{r}
# GML is same for baseline, adjacent, continuous and proportional odds
mfit1.1 <- glm(formula = outcome ~ dose, family = binomial, data = EG_data)
summary(mfit1.1)
-2*logLik(mfit1.1)
BIC(mfit1.1)
```

```{r}
#dose.dat <- data.frame(dose = c(0, 0.75, 1.5, 3.0))
#probabilities <- mfit1.1 %>% predict(dose.dat, type = "response")
#probabilities
```
```{r}
#predicted.classes <- ifelse(probabilities > 0.5, "pos", "neg")
#predicted.classes
```

```{r}
# Quasi-likelihood with inflated binomial inflation
EG$dose <- as.numeric(EG$dose)
mfit1.2 <- glm(formula = cbind(normal, size - normal) ~ dose, family = quasibinomial(link = "logit"), data = EG)
summary(mfit1.2)
#qic
```



```{r}
# Generalized estimating equations 
library(gee)
library(MuMIn)
geefitind = gee(outcome ~ dose, family = binomial(link="logit"), id = id, corstr="independence", data = EG_data)
summary(geefitind)
geefitexch = gee(outcome ~ dose, family = binomial(link="logit"), id = id, corstr="exchangeable", data = EG_data)
summary(geefitexch)
QIC(geefitind)
QIC(geefitexch)
```

```{r}
# Full likelihood
library(aod)
bbfit = betabin(cbind(normal, size - normal) ~ dose, ~1, data = EG)
summary(bbfit)
-2*logLik(bbfit)
AIC(bbfit)
BIC(bbfit)
```


```{r}
# Full likelihood
library(gamlss)
bbfitn = gamlss(cbind(normal, size - normal) ~ dose, sigma.formula=~1, family=BB, data = EG)
summary(bbfitn)
# rhohat=exp(logsigmahat)/(exp(logsigmahat)+1)1)
# sigma = rho/(1-rho) or rho = sigma/(sigma+1)
logsigmahat = bbfitn$sigma.coefficients
rhohat = exp(logsigmahat)/(exp(logsigmahat) + 1)
rhohat
```


```{r}
# Random effects model
#logistic-normal model
library(lme4)
#default is Laplacian approximation nAGQ=1
glmmfit1 <- glmer(cbind(normal, size - normal) ~ dose + (1|id), family = binomial(link="logit"), data = EG)
summary(glmmfit1)
#alternative data structure
gm1 <- glmer(outcome ~ dose + (1|id), family = binomial(link="logit"), data = EG_data)
summary(gm1)
# using penalized-quasi likelihood PQL approximation
library(mgcv)
glmmfit <- gamm(outcome ~ dose, family=binomial(link="logit"), random = list(id = ~ 1), data = EG_data)
summary(glmmfit$gam)
# using Adaptive Gauss-Hermite Quadrature approximation to the log-likelihood
# glmmfit2 <- glmer(cbind(normal, size - normal) ~ dose + (1|id), family = binomial(link="logit"), nAGQ = 2000, data = EG)
# summary(glmmfit2)
```

